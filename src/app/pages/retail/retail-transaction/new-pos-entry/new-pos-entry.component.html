

<div class="p-3">
  <!-- header section starts -->
  <div
    class="pos-sales-modalheader border-bottom d-flex justify-content-between p-1">
    <h5 class="pos-modaltitle" id="modal-dia-metal">Retail Sales</h5>
    <button type="button" class="btn btn-close close-btn" (click)="close()">
      <i class="feather icon-x close-icon"></i>
    </button>
  </div>
  <div class="row">
    <div class="col-md-12">
      <button type="button" mat-flat-button color="primary"
        (click)="addNew()">New</button>
    </div>
  </div>
  <!-- content section starts -->
  <div style="padding-top: 0px !important;">
    <div class="metal-sales-card">
      <!-- voucher data form starts -->
      <div class="row">
        <div class="col-md-12 p-3">
          <form [formGroup]="vocDataForm">
            <div class="row p-2"
              style="background-color: #ebeaea; margin-bottom: 10px">
              <div class="col-md-3 col-sm-12 m-t-10">
                <div class="datepick pt-1">
                  <input class="form-control flatpickr-input"
                    type="text" placeholder="Date*"
                    style="background: transparent;font-weight: 600;"
                    mwlFlatpickr dateFormat="d-m-Y" [maxDate]="currentDate"
                    formControlName="vocdate" [readonly]="viewOnly">
                </div>
              </div>
              <div class="col-md-3 col-sm-12 m-t-10">
                <mat-form-field>
                  <mat-label>Voc No</mat-label>
                  <input type="text" matInput
                    formControlName="fcn_voc_no"
                    [readonly]="true" />
                </mat-form-field>
              </div>
              <div class="col-md-3 col-sm-12 m-t-10">
                <mat-form-field>
                  <mat-label>Sales Person</mat-label>
                  <input type="text" matInput formControlName="sales_person"
                    id="sales_person" [matAutocomplete]="salesperson"
                    [readonly]="viewOnly" />
                  <mat-autocomplete #salesperson="matAutocomplete"
                    style="position: absolute; z-index: 1000;"
                    autoActiveFirstOption
                    (optionSelected)="changeSalesPerson($event.option.value)">
                    <mat-option
                      *ngFor="let option of salesPersonFilteredOptions | async"
                      [value]="option.SALESPERSON_CODE">
                      {{ option.SALESPERSON_CODE +' - '+ option.DESCRIPTION}}
                    </mat-option>
                  </mat-autocomplete>
                </mat-form-field>
              </div>

              <div class="col-md-3 col-sm-12" style="background-color: #d6d8da">
                <div class="form-group">
                  <div class="font-weight-bold"
                    style="font-size: 20px; font-weight: 400; color: #0d4f9e">
                    Net Total
                  </div>
                  <div style="font-size: 22px; font-weight: 500">
                    AED {{ order_items_total_net_amount | number : "1.2" }}
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="row">
        <!-- voucher type form ends -->
        <div class="col-md-9 col-sm-12">
          <!-- customer details form starts -->
          <div class="row">
            <form [formGroup]="customerDataForm"
              style="width: 100%; max-width: none">
              <div class="row">
                <div class="col-md-3 col-sm-12">
                  <mat-form-field>
                    <mat-label>Mobile Number</mat-label>
                    <input type="text"
                      onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                      matInput (focusout)="!viewOnly && onCustomerNameFocus()"
                      formControlName="fcn_customer_mobile"
                      [readonly]="viewOnly" />
                    <mat-error
                      *ngIf="customerDataForm.controls.fcn_customer_mobile.hasError('required')">
                      Mobile Number is <strong>required</strong>
                    </mat-error>
                  </mat-form-field>
                  <mat-progress-bar mode="indeterminate"
                    *ngIf="customerDetails.loader"></mat-progress-bar>
                </div>
                <div class="col-md-3 col-sm-12">
                  <mat-form-field>
                    <mat-label>Name</mat-label>
                    <input type="text" matInput
                      formControlName="fcn_customer_name"
                      (change)="nameChange($event)"
                      [readonly]="viewOnly" />
                    <mat-error
                      *ngIf="customerDataForm.controls.fcn_customer_name.hasError('required')">
                      Name is <strong>required</strong>
                    </mat-error>
                    <mat-error
                      *ngIf="customerDataForm.controls.fcn_customer_name.hasError('pattern')">
                      Whitespace Not Allowed
                    </mat-error>
                  </mat-form-field>
                </div>
                <div class="col-md-2 col-sm-12">
                  <mat-form-field>
                    <mat-label>ID Type </mat-label>
                    <input type="text" matInput
                      formControlName="fcn_customer_id_type"
                      [matAutocomplete]="idtype"
                      [readonly]="viewOnly" />
                    <mat-autocomplete #idtype="matAutocomplete"
                      (optionSelected)="changeIdtype($event.option.value)"
                      autoActiveFirstOption>
                      <mat-option
                        *ngFor="let option of idTypeFilteredOptions "
                        [value]="option">
                        {{ option }}
                      </mat-option>
                    </mat-autocomplete>
                  </mat-form-field>
                </div>
                <div class="col-md-2 col-sm-12">
                  <mat-form-field>
                    <mat-label>ID#</mat-label>
                    <input type="text" matInput
                      formControlName="fcn_customer_id_number"
                      [readonly]="viewOnly" />
                  </mat-form-field>
                </div>
                <div class="col-md-1 col-sm-12 justify-content-center">
                  <button type="button"
                    (click)="open('more_customer_detail_modal')"
                    mat-flat-button color="primary"
                    [disabled]="viewOnly"
                    style="font-size: 11px; padding: 0px 9px;">
                    {{ this.customerDetails.MOBILE == null || undefined ?
                    'Add Customer': 'Edit Customer' }}
                  </button>
                </div>
              </div>
            </form>
          </div>
          <!-- customer form ends -->
          <hr style="width: 100%" />
          <!-- product detail form starts -->
          <div class="m-t-10" style="padding: 0px">
            <mat-tab-group style="background-color: #f7f6f6;">
              <!-- Line Item TAB -->
              <mat-tab label="Line Item">
                <div class="table-responsive">
                  <div class="content">
                    <div class="left">
                      <div class="wrapper">
                        <div class="container" style="padding: 0px">
                          <dx-data-grid id="gridContainer"
                            [dataSource]="ordered_items" keyExpr="ID"
                            [showBorders]="true"
                            (onRowRemoved)="removeLineItemsGrid($event)"
                            (onEditingStart)="editTable($event)"
                            [columnAutoWidth]="true">
                            <dxo-editing [allowUpdating]="true"
                              [allowDeleting]="!viewOnly">
                              <dxo-texts [editRow]="viewOnly? 'View' : 'Edit' "
                                deleteRow="Remove"> </dxo-texts>
                            </dxo-editing>
                            <dxo-selection mode="single"></dxo-selection>
                            <dxi-column dataField="sn_no" width="50"
                              caption="SLNo" [allowEditing]="false"
                              alignment="center">
                            </dxi-column>
                            <dxi-column dataField="stock_code" width="100"
                              [allowEditing]="false">
                            </dxi-column>
                            <dxi-column dataField="description" width="150"
                              [allowEditing]="false" alignment="center">
                            </dxi-column>
                            <dxi-column dataField="weight" caption="Weight"
                              width="100" [allowEditing]="false">
                            </dxi-column>
                            <dxi-column dataField="pcs" caption="Pcs"
                              width="100"
                              [allowEditing]="false"></dxi-column>
                            <dxi-column dataField="total_amount"
                              caption="Mkg amount" alignment="right"
                              format="currency"
                              [format]="{ style: 'currency', currency: 'AED' }"
                              [allowEditing]="false"
                              precision="2"></dxi-column>
                            <dxi-column dataField="net_amount"
                              caption="Total amount" alignment="right"
                              format="currency"
                              [format]="{ style: 'currency', currency: 'AED' }"
                              [allowEditing]="false" precision="2">
                            </dxi-column>

                            <dxo-summary>
                              <dxi-total-item column="sn_no" summaryType="count">
                              </dxi-total-item>
                              <dxi-total-item column="stock_code"
                                summaryType="min"
                                [customizeText]="customizeDate">
                              </dxi-total-item>
                              <dxi-total-item column="weight" summaryType="sum"
                                caption="Weight"
                                [customizeText]="customizeWeight">
                              </dxi-total-item>
                              <dxi-total-item column="pcs" summaryType="sum"
                                [customizeText]="customizeQty">
                              </dxi-total-item>
                              <dxi-total-item column="total_amount"
                                summaryType="sum" displayFormat="AED {0}"
                                type="fixedPoint" precision="2"
                                [valueFormat]="{ currency: 'AED' }">
                              </dxi-total-item>
                              <dxi-total-item column="net_amount"
                                summaryType="sum"
                                displayFormat="AED {0}" precision="2"
                                [valueFormat]="{ currency: 'AED' }">
                              </dxi-total-item>
                            </dxo-summary>
                          </dx-data-grid>
                        </div>

                        <div>
                          <button mat-mini-fab color="primary" class="m-2"
                            type="submit"
                            (click)="open('mymodal')">
                            <i class="fa fa-plus"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-tab>
              <!-- Sales Return -->
              <mat-tab label="Sales Return">
                <div class="table-responsive">
                  <div class="content">
                    <div class="left">
                      <div class="wrapper">
                        <div class="container">
                          <dx-data-grid id="sales_return_grid"
                            [dataSource]="sales_returns_items" keyExpr="ID"
                            (onRowRemoved)="removeSalesReturnGrid($event)"
                            (onEditingStart)="editTableSalesReturn($event)"
                            [showBorders]="true" [columnAutoWidth]="true">
                            <dxo-editing [allowUpdating]="true"
                              [allowDeleting]="!viewOnly">
                              <dxo-texts [editRow]="viewOnly? 'View' : 'Edit' "
                                deleteRow="Remove"> </dxo-texts>
                            </dxo-editing>
                            <dxo-selection mode="single"></dxo-selection>
                            <dxi-column dataField="sn_no" width="50"
                              caption="SLNo" [allowEditing]="false">
                            </dxi-column>
                            <dxi-column dataField="stock_code" width="100"
                              [allowEditing]="false">
                            </dxi-column>
                            <dxi-column dataField="description" width="200"
                              [allowEditing]="false"></dxi-column>
                            <dxi-column dataField="weight" caption="Weight"
                              width="100" [allowEditing]="false">
                            </dxi-column>
                            <dxi-column dataField="pcs" caption="Pcs"
                              width="100"
                              [allowEditing]="false"></dxi-column>
                            <dxi-column dataField="mkg_amount" alignment="right"
                              format="currency"
                              [format]="{ style: 'currency', currency: 'AED' }"
                              [allowEditing]="false"></dxi-column>
                            <dxi-column dataField="total_amount"
                              alignment="right"
                              format="currency"
                              [format]="{ style: 'currency', currency: 'AED' }"
                              [allowEditing]="false">
                            </dxi-column>

                            <dxo-summary>
                              <dxi-total-item column="sn_no" summaryType="count">
                              </dxi-total-item>
                              <dxi-total-item column="stock_code"
                                summaryType="min"
                                [customizeText]="customizeDate">
                              </dxi-total-item>
                              <dxi-total-item column="weight" summaryType="sum"
                                caption="Total Wt"
                                [customizeText]="customizeWeight">
                              </dxi-total-item>
                              <dxi-total-item column="pcs" summaryType="sum"
                                [customizeText]="customizeQty">
                              </dxi-total-item>
                              <dxi-total-item column="mkg_amount"
                                summaryType="sum"
                                displayFormat="AED {0}"
                                [valueFormat]="{ currency: 'AED' }">
                              </dxi-total-item>
                              <dxi-total-item column="total_amount"
                                summaryType="sum" displayFormat="AED {0}"
                                [valueFormat]="{ currency: 'AED' }">
                              </dxi-total-item>
                            </dxo-summary>
                          </dx-data-grid>

                          <div>
                            <button mat-mini-fab color="primary" class="m-2"
                              type="submit"
                              (click)="open('adjust_sale_return_modal')">
                              <i class="fa fa-plus"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-tab>
              <!-- Exchange -->
              <mat-tab label="Exchange">
                <div class="table-responsive">
                  <div class="content">
                    <div class="left">
                      <div class="wrapper">
                        <div class="container">
                          <dx-data-grid id="exchange_item_grid"
                            [dataSource]="exchange_items" keyExpr="ID"
                            (onRowRemoved)="removeExchangeItemGrid($event)"
                            [showBorders]="true" [columnAutoWidth]="true"
                            (onEditingStart)="editTableExchangeItem($event)">
                            <!-- <dxo-editing [allowUpdating]="false" [allowDeleting]="true">
                            <dxo-texts deleteRow="Remove"> </dxo-texts>
                          </dxo-editing> -->
                            <dxo-editing [allowUpdating]="true"
                              [allowDeleting]="!viewOnly">
                              <dxo-texts [editRow]="viewOnly? 'View' : 'Edit' "
                                deleteRow="Remove"> </dxo-texts>
                            </dxo-editing>
                            <dxo-selection mode="single"></dxo-selection>
                            <dxi-column dataField="sn_no" width="50"
                              caption="SLNo" [allowEditing]="false">
                            </dxi-column>
                            <dxi-column dataField="stock_code" width="100"
                              [allowEditing]="false">
                            </dxi-column>
                            <dxi-column dataField="description" width="200"
                              [allowEditing]="false"></dxi-column>
                            <dxi-column dataField="weight" caption="Weight"
                              width="100" [allowEditing]="false">
                            </dxi-column>
                            <dxi-column dataField="pcs" caption="Pcs"
                              width="100"
                              [allowEditing]="false"></dxi-column>
                            <dxi-column dataField="net_amount" alignment="right"
                              format="currency"
                              [format]="{ style: 'currency', currency: 'AED' }"
                              [allowEditing]="false">
                            </dxi-column>

                            <dxo-summary>
                              <dxi-total-item column="sn_no" summaryType="count">
                              </dxi-total-item>
                              <dxi-total-item column="stock_code"
                                summaryType="min"
                                [customizeText]="customizeDate">
                              </dxi-total-item>
                              <dxi-total-item column="weight" summaryType="sum"
                                caption="Total Wt"
                                [customizeText]="customizeWeight">
                              </dxi-total-item>
                              <dxi-total-item column="pcs" summaryType="sum"
                                [customizeText]="customizeQty">
                              </dxi-total-item>
                              <dxi-total-item column="net_amount"
                                summaryType="sum"
                                displayFormat="AED {0}"
                                [valueFormat]="{ currency: 'AED' }">
                              </dxi-total-item>
                            </dxo-summary>
                          </dx-data-grid>

                          <div>
                            <button mat-mini-fab color="primary" class="m-2"
                              type="submit"
                              (click)="open('exchange_modal')">
                              <i class="fa fa-plus"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-tab>
            </mat-tab-group>
            <hr style="width: 100%" />
          </div>
          <!-- product detail form ends -->
          <!-- reciept section starts -->
          <div class="row" style="margin-top: 0px">
            <div class="col-md-6">
              <div class="card m-t-10">
                <div class="card-header">
                  <b (click)="open(sales_payment_modal)"
                    style="color: #0861a9; cursor: pointer; text-decoration: underline;">
                    Receipt Details
                  </b>
                  <span style="float:right;">
                    <button type="submit" (click)="open('sales_payment_modal')"
                      style
                      class="btn btnsml btn-secondary w-30">Add</button>
                  </span>
                </div>
                <div class="card-body receipt-details">
                  <table class="tabletd_gray">
                    <tr>
                      <th>Mode</th>
                      <th>Currency</th>
                      <th>Amount LC</th>
                      <th>&nbsp;</th>
                    </tr>
                    <tr
                      *ngFor="let rec_details of receiptDetailsList; let id= index">
                      <td>{{ rec_details.RECEIPT_MODE }}</td>
                      <td>{{ rec_details.CURRENCY_CODE }}</td>
                      <td style="text-align: right; padding-right: 3px">
                        {{ rec_details.AMOUNT_FC }}
                      </td>
                      <td *ngIf="viewOnly">
                        <button type="submit"
                          (click)="editReceiptItem(id, rec_details)"
                          class="btn btnsml btn-primary w-30 m-l-10">
                          <i class="fa fa-eye"></i>
                        </button>
                      </td>
                      <td *ngIf="!viewOnly">
                        <button type="submit"
                          (click)="editReceiptItem(id, rec_details)"
                          class="btn btnsml btn-primary w-30 m-l-10">
                          <i class="fa fa-edit"></i>
                        </button>
                        <button type="submit" (click)="removePayments(id)"
                          class="btn btnsml btn-danger w-30 m-l-10">
                          <i class="fa fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </table>
                  <div class="row">
                    <div class="col-md-12 text-right m-t-10">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- reciept section ends -->
        </div>
        <!-- selling price total amount Right side section starts -->
        <div class="col-md-3 col-sm-12">
          <div class="card p-2" style="background-color: #ececec !important">
            <div style="height: 100px; overflow-y: scroll">
              <table class="tabletd_gray">
                <tr>
                  <th style="width: 50%">Karat</th>
                  <!-- <th style="width: 50%">Karat </th> -->
                  <th>Selling Price</th>
                  <!-- <th>Buying Price</th> -->
                </tr>
                <tr *ngFor="let krd of karatRateDetails; let id= index">
                  <td>{{ krd.KARAT_CODE }}</td>
                  <td style="text-align: right; padding-right: 3px">
                    <input type="number" (change)="changeKaratRate($event, id)"
                      style="text-align: right;"
                      onwheel="this.blur()" [value]="krd.KARAT_RATE"
                      class="karat_code"
                      [readOnly]="viewOnly ? true: false   ">
                    <!-- {{ krd.KARAT_RATE }} -->
                  </td>
                  <!-- <td style="text-align:right;padding-right:3px;"> {{krd.POPKARAT_RATE}} </td> -->
                </tr>
              </table>
            </div>
            <table class="m-t-10 rhs-table-1">
              <tr>
                <td class="td-w-40">Amount</td>
                <!-- <td class="td-w-40">Total Amount</td> -->
                <td>
                  <input type="text" class="form-control textboxcorner" id
                    value="{{ prnt_inv_total_gross_amt | number : '1.2'}}"
                    aria-describedby placeholder="0.00"
                    readonly />
                </td>
              </tr>
              <tr>
                <td class="td-w-40">Tax Amount</td>
                <td>
                  <input type="text" class="form-control textboxcorner" id
                    value="{{ this.order_items_total_tax | number : '1.2'}}"
                    aria-describedby placeholder="0.00"
                    readonly />
                </td>
              </tr>
              <tr>
                <td class="td-w-40">Amount with tax</td>
                <!-- <td class="td-w-40">Gross Total</td> -->
                <td>
                  <input type="text" class="form-control textboxcorner" id
                    value="{{ order_items_total_gross_amount | number : '1.2'}}"
                    aria-describedby placeholder="0.00"
                    readonly />
                </td>
              </tr>
              <tr>
                <td class="td-w-40" style="background: #adacab">
                  Sales Return
                </td>
                <td>
                  <input type="text" class="form-control textboxcorner" id
                    value="{{ invReturnSalesTotalNetTotal | number : '1.2'}}"
                    aria-describedby placeholder="0.00"
                    readonly />
                </td>
              </tr>
              <tr>
                <td class="td-w-40" style="background: #adacab">Exchange</td>
                <td>
                  <input type="text" class="form-control textboxcorner" id
                    value="{{ order_total_exchange | number : '1.2'}}"
                    aria-describedby placeholder="0.00"
                    readonly />
                </td>
              </tr>
              <tr>
                <td class="td-w-40"
                  style="background-color: #1a61a9; color: #fff">
                  <b>Discount</b>
                </td>
                <td>
                  <input type="text" class="form-control textboxcorner" id
                    value="{{ order_items_total_discount_amount | number : '1.2'}}"
                    aria-describedby placeholder="0"
                    readonly />
                </td>
                <!-- <td>
                <input type="text" class="form-control textboxcorner" id=""
                  value="{{ order_items_total_discount_amount }}" aria-describedby="" placeholder="0" />
              </td> -->
              </tr>
              <tr>
                <td class="td-w-40"
                  style="background-color: #1a61a9; color: #fff">
                  <b>Net Amount</b>
                </td>
                <td>
                  <input type="text" class="form-control textboxcorner" id
                    value="{{ order_items_total_net_amount | number : '1.2' }}"
                    aria-describedby placeholder="0.00"
                    readonly />
                </td>
              </tr>

              <tr>
                <td class="td-w-40"
                  style="background-color: #1a61a9; color: #fff">
                  <b>Received</b>
                </td>
                <td>
                  <input type="text" class="form-control textboxcorner" id
                    [(ngModel)]="receiptTotalNetAmt"
                    value="{{ receiptTotalNetAmt }}" aria-describedby
                    placeholder="0.00" readonly />
                  <!-- <input type="text" class="form-control textboxcorner" id="" [(ngModel)]="order_received_amount"
                  value="{{ order_received_amount }}" aria-describedby="" placeholder="0.00" readonly /> -->
                </td>
              </tr>
            </table>
            <!-- save bill / cancel buttons section-->
            <div>
              <div class="row m-t-10 m-b-10">
                <div class="col-md-6 col-xl-6" style="padding-right: 5px"
                  (click)="backToList()" *ngIf="viewOnly">
                  <div class="touch-big-button touch-big-button-black">
                    <div class="touch-big-button-inner">
                      <i class="fa fa-arrow-circle-left"></i> <span> Back</span>
                    </div>
                  </div>
                </div>

                <div class="col-md-6 col-xl-6"
                  matTooltip="You have already saved"
                  [matTooltipDisabled]="isSaved"
                  style="padding-right: 5px;"
                  (click)="viewOnly || isSaved ? '' :saveOrder()"
                  *ngIf="!viewOnly">
                  <div class="touch-big-button touch-big-button-black">
                    <div class="touch-big-button-inner p-2">
                      <i class="fa fa-save"></i> <span> Save Bill</span>
                    </div>
                  </div>
                </div>

                <div class="col-md-6 col-xl-6" style="padding-left: 5px">
                  <app-print-invoice></app-print-invoice>
                </div>
              </div>

              <div class="row mt-2" *ngIf="!viewOnly">
                <div class="col-md-6 col-xl-6" style="padding-right: 5px">
                  <div class="touch-big-button touch-big-button-black">
                    <div class="touch-big-button-inner p-2"><i
                        class="fa fa-search"></i>
                      <span> Search</span></div>
                  </div>
                </div>

                <div class="col-md-6 col-xl-6" style="padding-left: 5px"
                  routerLink="/pos">
                  <div class="touch-big-button">
                    <div class="touch-big-button-inner p-1">
                      <i class="fa fa-window-close pe-2"></i> <span> Cancel Bill</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- selling price total amount Right side section ends -->
      </div>

    </div>
  </div>
</div>
<!-- modal selections -->
<ng-template #more_customer_detail_modal let-modal modal-lg>
  <!-- <app-add-customer (closebtnClick)="closeModal()"></app-add-customer> -->
  <app-pos-customer-master (closebtnClick)="closeModal()"></app-pos-customer-master>
</ng-template>
<ng-template #mymodal let-modal modal-lg>
  <app-add-items (closebtnClick)="closeModal()"></app-add-items>
</ng-template>
<ng-template #adjust_sale_return_modal let-modal modal-lg>
  <app-add-sales-return (closebtnClick)="closeModal()"></app-add-sales-return>
</ng-template>
<ng-template #exchange_modal let-modal modal-lg>
  <app-add-exchange (closebtnClick)="closeModal()"></app-add-exchange>
</ng-template>
<ng-template #sales_payment_modal let-modal modal-lg>
  <app-add-payment (closebtnClick)="closeModal()"></app-add-payment>
</ng-template>